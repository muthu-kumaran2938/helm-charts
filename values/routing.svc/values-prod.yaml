replicaCount: 2

image:
  repository: myacr.io/route-service
  tag: "1.0.3"
  pullPolicy: IfNotPresent

resources:
  requests:
    cpu: "300m"
    memory: "512Mi"
  limits:
    cpu: "800m"
    memory: "1Gi"

container:
  ports:
    - name: http
      containerPort: 8080
      servicePort: 80
      protocol: TCP
    - name: manage
      containerPort: 9080
      servicePort: 9080
      protocol: TCP

service:
  type: ClusterIP

ingress:
  enabled: true
  port: http

healthchecks:
  livenessProbe:
    httpGet:
      path: /actuator/health
      port: manage
    initialDelaySeconds: 60
    timeoutSeconds: 5
  readinessProbe:
    httpGet:
      path: /actuator/health
      port: manage
    initialDelaySeconds: 30
    timeoutSeconds: 5

serviceMonitor:
  enabled: true
  path: /actuator/prometheus
  port: manage
  interval: 30s

prometheusRules:
  enabled: true
  groups:
    - name: route-service-alerts
      rules:
        - alert: RouteServiceDown
          expr: up{job="route-service"} == 0
          for: 5m
          labels:
            severity: warning
            assignment_group: ROUTING
          annotations:
            summary: "Route service is down"
            description: "No running instances for route-service"

hpa:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  cpu: 70
  memory: 80

pdb:
  enabled: true
  minAvailable: 1

serviceAccount:
  create: true
  annotations: {}

envFromSecrets:
  enabled: true
  name: route-service-secret

externalSecrets:
  enabled: true
  refreshInterval: 1h
  secretStore: aws-secrets-manager
  data:
    - secretKey: DB_USERNAME
      remoteRef:
        key: prod/route-service/db
        property: username
    - secretKey: DB_PASSWORD
      remoteRef:
        key: prod/route-service/db
        property: password

grafanaDashboards:
  enabled: true
  folder: "Routing Services"
  dashboards:
    route-overview.json: |-
      {
        "title": "Route Service - Overview",
        "timezone": "browser",
        "schemaVersion": 36,
        "version": 1,
        "panels": [
          {
            "type": "timeseries",
            "title": "JVM Memory Used",
            "targets": [
              {
                "expr": "jvm_memory_used_bytes{app=\"route-service\"}",
                "refId": "A"
              }
            ]
          },
          {
            "type": "timeseries",
            "title": "HTTP Requests",
            "targets": [
              {
                "expr": "http_server_requests_seconds_count{app=\"route-service\"}",
                "refId": "B"
              }
            ]
          }
        ]
      }

labels:
  app: route-service
  env: prod

annotations:
  argocd-image-updater.argoproj.io/image-list: route-service=myacr.io/route-service
  argocd-image-updater.argoproj.io/update-strategy: latest

configMaps:
  /spring/config:
    inline:
      - name: application.properties
        content: |-
          spring.application.name=route-service
          server.port=8080
          management.server.port=9080
          management.endpoints.web.exposure.include=health,prometheus
          logging.level.root=INFO
ingress:
  enabled: true
  host: route.example.com
  port: http
  tls:
    enabled: true
    secretName: route-service-tls
    issuer: letsencrypt-prod

